---
title: "Apatite Data_Plots_v5"
author: "Spencer  Zeigler"
date: "12/14/2020"
output:
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    code_folding: show
    css: stylesheet.css
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options:
  chunk_output_type: console
---

## Setup libaries, themes, global objects:
```{r setup, include=FALSE}
library(MASS)
library(latex2exp)
library(readxl)
library(ggplot2)
library(tidyverse)
library(tidyr)
library(plotly)
library(scales)
library(dplyr)
library(readr)
library(plotly)
library(RColorBrewer)
library(xlsx)
library(ggsci)
library(patchwork)
library(viridis)
library(scales)
library(performance)
library(glue)
library(tinytex)
par(mfrow=c(1, 1)) #how to arrange plots, 1 per row, 1 per column

#Theme options
theme_set(theme_linedraw())
options(scipen = 999) #prints numbers instead of scientific notation

#Color Palettes 
cb1 <- c("#440154FF", "#39558CFF", "#74D055FF", "#FDE725FF") #colorblind pal
```

## Import Data
```{r}
apatite <- read_excel("./Data Comps_v7.xlsx", sheet="Data Comps") #This loads data from a .xlsx. Must name the sheet if there are multiple sheets. 
as_tibble(apatite)

apatite <- apatite %>%
  filter(!is.na(apatite$empty)) #this gets rid of data points that are missing information
```

## Setting cols as factor for plotting
```{r}
#Must set as factor to keep the order and colors matching in ggplot. 

apatite$size.bin <- factor(apatite$size.bin, levels = c("40-50", "51-60", "61-70", "71-80", "81-90", "91-100", "101-110", "111-120", "121-130", "131-140", "141-150", "151-160", "161-170"))
apatite$s.gem <- factor(apatite$s.gem, levels = c("A1", "A2", "A3", "B1", "B2", "B3", "C1", "C2", "C3"))
df7.rm$ri <- factor(df7.rm$ri, levels = c("1", "2", "3"))
apatite$size.name <- factor(apatite$size.name, levels=c("Small & Never","Small & Rarely","Average", "Large & Common", "Large & Rarely"))
apatite$gem.cat <- factor(apatite$gem.cat, levels = c("Best.GEM", "Average.GEM", "Worst.GEM"))
common_apatite$np <- factor(common_apatite$np, levels= c("0", "1", "2"))

```

## Creating Dataframes 
```{r}
#Grains Removed
common_apatite <- apatite %>%
  filter(!size.name == "Large & Rare", !size.name == "Small & Rare")

#Dataframe by Roughness Index 
ri1 <- common_apatite %>% filter(ri=="1")
ri2 <- common_apatite %>% filter(ri=="2")
ri3 <- common_apatite %>% filter(ri=="3")

#Dataframe by Geometric Classification
gca <- common_apatite %>% filter(gc=="A") 
gcb <- common_apatite %>% filter(gc=="B") 
gcc <- common_apatite %>% filter(gc=="C") 
ab <- common_apatite %>% filter(gc == "A" | gc == "B") %>% mutate(s.gem= "AB")

#Create Dataframes split by both geometry and roughness 
a1 <- common_apatite %>% filter(s.gem == "A1") 
a2 <- common_apatite %>% filter(s.gem == "A2")
a3 <- common_apatite %>% filter(s.gem == "A3")
b1 <- common_apatite %>% filter(s.gem == "B1") 
b2 <- common_apatite %>% filter(s.gem == "B2")
b3 <- common_apatite %>% filter(s.gem == "B3")
c1 <- common_apatite %>% filter(s.gem == "C1") 
c2 <- common_apatite %>% filter(s.gem == "C2")
c3 <- common_apatite %>% filter(s.gem == "C3")

#Make dataframes based on terminations 
term0 <- common_apatite %>% filter(np == "0")
term1 <- common_apatite %>% filter(np == "1")
term2 <- common_apatite %>% filter(np =="2")
```


```{r}
percent <- function(grains) {
  return(grains/nrow(common_apatite) * 100)
}
percent(34)
```

## Creating Dataframes 
```{r}
#Dataframe by Roughness Index 
ri1 <- apatite %>% filter(ri=="1")
ri2 <- apatite %>% filter(ri=="2")
ri3 <- apatite %>% filter(ri=="3")

#Dataframe by Geometric Classification
gca <- apatite %>% filter(gc=="A") 
gcb <- apatite %>% filter(gc=="B") 
gcc <- apatite %>% filter(gc=="C") 
ab <- apatite %>% filter(gc == "A" | gc == "B") %>% mutate(s.gem= "AB")

#Create Dataframes split by both geometry and roughness 
a1 <- apatite %>% filter(s.gem == "A1") 
a2 <- apatite %>% filter(s.gem == "A2")
a3 <- apatite %>% filter(s.gem == "A3")
b1 <- apatite %>% filter(s.gem == "B1") 
b2 <- apatite %>% filter(s.gem == "B2")
b3 <- apatite %>% filter(s.gem == "B3")
c1 <- apatite %>% filter(s.gem == "C1") 
c2 <- apatite %>% filter(s.gem == "C2")
c3 <- apatite %>% filter(s.gem == "C3")

#Make dataframes based on terminations 
term0 <- apatite %>% filter(np == "0")
term1 <- apatite %>% filter(np == "1")
term2 <- apatite %>% filter(np =="2")
```


#Function to set theme and plot error lines for ggplot
```{r}
error.lines <- function(large.error = FALSE) {

  theme_set(theme_light())

  if (large.error == FALSE) { 
  p <<- ggplot() + 
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2)  #20%
  }

  if (large.error == TRUE) { 
  p <<- ggplot() +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2)  #20%
  geom_abline(slope=.7, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=1.42, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=.6, intercept=0, size=.1, linetype= 2) + #40%
  geom_abline(slope=1.66, intercept=0, size=.1, linetype= 2)  #40%
  }
}
```

Exploring terminations influence on Ft
```{r}
error.lines()

p + 
  #xlim(.25, .9) + ylim(.25, .9) +
  labs(title = "Manual 2D vs. Nano-CT 3D Ft", x= "2D Ft", y= "3D Ft") + 
  scale_color_brewer(palette= "Set1", 
                     name= "Np",
                    labels= c("0", "1", "2")) +
  geom_smooth(mapping=aes(x = s.ft, y = db.ft, color=np), data=common_apatite, method="lm", se=FALSE) +
  geom_point(common_apatite, mapping=aes(x = s.ft, y = db.ft, color=np), size = 2) 
```

Exploring terminations influence on volume
```{r}
error.lines(large.error=TRUE) 

p +
  #xlim(0,750000) + ylim(0, 1000000) +
  labs(title = "Manual 2D vs. Nano-CT 3D Volume", subtitle = "zoomed out", x= "2D Volume", y= "3D Volume") + 
  scale_color_brewer(palette= "Set1", 
                     name= "Np",
                    labels= c("0", "1", "2")) +
  geom_smooth(mapping=aes(x = s.v, y = db.v, color=np), data=common_apatite, method="lm", se=FALSE) +
  geom_point(common_apatite, mapping=aes(x = s.v, y = db.v, color=np), size = 2)
```

Exploring terminations influence on ESR Ft
```{r}
error.lines()
p + 
  labs(title = "Manual 2D vs. Nano-CT 3D ESR Ft", x= "2D ESR Ft", y= "3D ESR Ft") + 
  scale_color_brewer(palette= "Set1", 
                     name= "Np",
                    labels= c("0", "1", "2")) +
  geom_smooth(mapping=aes(x = s.esr.ft, y = db.esr.ft, color=np), data=common_apatite, method="lm", se=FALSE) +
  geom_point(common_apatite, mapping=aes(x = s.esr.ft, y = db.esr.ft, color=np), size = 2) 
```

```{r}
plot(apatite$s.v, apatite$db.v)
abline(0,1)
```

########## Ft Plots


Ft- All Grains- OG- Scatterplot
```{r}
error.lines()
p +
  labs(title = "Manual 2D vs. Nano-CT 3D Ft", subtitle="Calculated Using Ketcham et al., 2011", x= "2D Ft", y= "3D Ft") + 
  scale_color_brewer(palette="Dark2", 
                     name= "Geometric Index",
                    labels= c("A", "B", "C")) +
  geom_point(apatite, mapping=aes(x = s.ft.og, y = db.ft, color = gc), size = 2)
```

Ft- All Grains- OG vs Max - Scatterplot
```{r}
ggplot() + 
  xlim(.25, .9) + ylim(.25, .9) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  labs(title = "Manual 2D vs. Nano-CT 3D Ft", subtitle="Both Geo, Both Widths (OG) vs Max Widths", x= "2D Ft", y= "3D Ft") + 
  #scale_color_manual(palette=c("grey15", "cornflowerblue"), name= "Legend", labels= c("Both Widths, Both Geo", "Max Widths, Both Geo")) +
  geom_point(df7, mapping=aes(x = s.ft.og, y = db.ft), color= "grey15", size = 2) +
  geom_point(df7, mapping=aes(x=s.ft, y=db.ft), color= "cornflowerblue", size=2)
```

Ft- All Grains- Max- Scatterplot + Regression
```{r}
ggplot() + 
  #xlim(.25, .9) + ylim(.25, .9) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  labs(title = "Manual 2D vs. Nano-CT 3D Ft", subtitle="All Grains, With Regression Lines (lm)", x= "2D Ft", y= "3D Ft") + 
  scale_color_brewer(palette= "Set1", 
                     name= "Geometric Index",
                    labels= c("A", "B", "C")) +
  geom_smooth(mapping=aes(x = s.ft, y = db.ft, color=gc), data=df7, method="lm", se=FALSE) +
  geom_point(df7, mapping=aes(x = s.ft, y = db.ft, color=gc), size = 2) 
```

#Ft- Common Only- Max- Scatterplot + Regression
```{r}
ggplot() + 
  #xlim(.25, .9) + ylim(.25, .9) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  labs(title = "Manual 2D vs. Nano-CT 3D Ft", subtitle="Common Grains Only, With Regression Lines (lm)", x= "2D Ft", y= "3D Ft") + 
  scale_color_viridis(discrete = TRUE, 
                     name= "Geometric Index",
                    labels= c("A", "B", "C")) +
  #geom_smooth(mapping=aes(x=s.ft, y=db.ft, color=gc), data= df7.rm, method="lm", se=FALSE) +
  geom_point(df7, mapping=aes(s.ft, db.ft), color= "grey70", size=2) +
  geom_point(df7.rm, mapping=aes(x = s.ft, y = db.ft, color=gc), size = 2)

```

#Ft- Common + Small Grains- Max- Scatterplot + Regression
```{r}
ggplot() + 
  #xlim(.25, .9) + ylim(.25, .9) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  labs(title = "Manual 2D vs. Nano-CT 3D Ft", subtitle="Common + Small Grains, With Regression Lines (lm)", x= "2D Ft", y= "3D Ft") + 
  scale_color_brewer(palette= "Dark2", 
                     name= "Geometric Index",
                    labels= c("A", "B", "C")) +
                  
  geom_point(df7.small, mapping=aes(x = s.ft, y = db.ft, color=gc), size = 2) +
  geom_smooth(mapping=aes(x = s.ft, y = db.ft, color=gc), data= df7.small, method="lm", se=FALSE) 

#ggplotly(ftp4, tooltip=c("key"))
```

#Ft- Common + Large Grains- Max- Scatterplot
```{r}
ggplot() + 
  #xlim(.25, .9) + ylim(.25, .9) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  
  labs(title = "Manual 2D vs. Nano-CT 3D Ft", subtitle="Common + Large Grains, With Regression Lines (lm)", x= "2D Ft", y= "3D Ft") + 
 scale_color_brewer(palette= "Dark2", 
                     name= "Geometric Index",
                    labels= c("A", "B", "C")) +
  
  geom_point(df7.large, mapping=aes(x = s.ft, y = db.ft, color=gc), size = 2) +
  geom_smooth(mapping=aes(x = s.ft, y = db.ft, color=gc), data= df7.large, method="lm", se=FALSE) 


#ggplotly(ftp4, tooltip=c("key"))
```

#Ft- Results Plot
```{r}
ggplot() + 
  #xlim(.25, .9) + ylim(.25, .9) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  labs( x= "2D Ft", y= "3D Ft") + 
  scale_color_manual(values= c("#453781FF", "#3CBC75FF", "#DCE318FF", "#20A386FF", "#238A8DFF", "#FDE725FF", "#74D055FF", "#39558CFF", "#440154FF"), 
                     name= "Geometric Index",
                    labels= c("A and B", "C")) +
  #geom_smooth(mapping=aes(x=s.ft, y=db.ft, color=s.gem), data= df.ab, method="lm", se=FALSE, size=1.5) +
  geom_abline(mapping=aes(slope =0.9749, intercept =0, color= s.gem), data=ab, size=1.2) +
  #geom_smooth(mapping=aes(x=s.ft, y=db.ft, color=gc), data= df.gcc, method="lm", se=FALSE, size=1.5) +
  geom_abline(mapping=aes(slope =0.9284, intercept =0, color= gc), data=gcc, size=1.2) +
  geom_point(apatite, mapping=aes(s.ft, db.ft), color= "grey70", size=2) +
  geom_point(ab, mapping=aes(x = s.ft, y = db.ft, color=s.gem), size = 2) +
  geom_point(gcc, mapping=aes(s.ft, db.ft, color=gc), size=2)

```


Common Grains Only plotted by Geometry and colored by roughness. Regression line based on geometry plotted in red. 
```{r}
pa <- ggplot() + 
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  geom_abline(slope = 0.9754, intercept = 0, color = "red") +
  geom_point(gca, mapping=aes(s.ft, db.ft, color=as.factor(ri)), size =2) + 
  scale_color_viridis(discrete = TRUE) +
  labs(x= "2D Ft", y= "3D Ft", title ="A", subtitle = "slope= 0.9754; std error= 0.02162") 

pb <- ggplot() + 
  geom_abline(slope = 1, intercept = 0, linetype =2) + 
  geom_abline(slope = 0.9746, intercept = 0, color = "red") +
  geom_point(gcb, mapping=aes(s.ft, db.ft, color=as.factor(ri)), size =2) + 
  scale_color_viridis(discrete = TRUE) +
  labs(x= "2D Ft", y= "3D Ft", title ="B", subtitle = "slope= 0.9746; std error= 0.02518") 

pc <- ggplot() + 
  geom_abline(slope = 1, intercept = 0, linetype = 2) + 
  geom_abline(slope = 0.9284, intercept = 0, color = "red") +
  geom_point(gcc, mapping=aes(s.ft, db.ft, color=as.factor(ri)), size =2) + 
  scale_color_viridis(discrete = TRUE) +
  labs(x= "2D Ft", y= "3D Ft", title ="C", subtitle = "slope= 0.9284; std error= 0.02453") 

pa / pb / pc
```

Common Grains Only plotted by Roughness and colored by geometry. Regression line based on roughness plotted in red. 
```{r}
p1 <- ggplot() + 
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  geom_abline(slope = 0.975, intercept = 0, color = "red") +
  geom_point(ri1, mapping=aes(s.ft, db.ft, color=gc), size =2) + 
  scale_color_viridis(discrete = TRUE) +
  labs(x= "2D Ft", y= "3D Ft", title ="1", subtitle = "slope= 0.975; std error= 0.02199") 

p2 <- ggplot() + 
  geom_abline(slope = 1, intercept = 0, linetype =2) + 
  geom_abline(slope = 0.9713, intercept = 0, color = "red") +
  geom_point(ri2, mapping=aes(s.ft, db.ft, color=gc), size =2) + 
  scale_color_viridis(discrete = TRUE) +
  labs(x= "2D Ft", y= "3D Ft", title ="2", subtitle = "slope= 0.9713; std error= 0.02226") 

p3 <- ggplot() + 
  geom_abline(slope = 1, intercept = 0, linetype = 2) + 
  geom_abline(slope = 0.9478, intercept = 0, color = "red") +
  geom_point(ri3, mapping=aes(s.ft, db.ft, color=gc), size =2) + 
  scale_color_viridis(discrete = TRUE) +
  labs(x= "2D Ft", y= "3D Ft", title ="3", subtitle = "slope= 0.9478; std error= 0.03478") 

p1 / p2 / p3
```



########## Volume Plots

GEM plots of common grains only with regression slope plotted! 
```{r}
pa1 <- plot.gem(a1, "A1", vol = T)
pb1 <- plot.gem(b1, "B1", vol = T)
pc1 <- plot.gem(c1, "C1", vol = T)
pa2 <- plot.gem(a2, "A2", vol = T)
pb2 <- plot.gem(b2, "B2", vol = T)
pc2 <- plot.gem(c2, "C2", vol = T)
pa3 <- plot.gem(a3, "A3", vol = T)
pb3 <- plot.gem(b3, "B3", vol = T)
pc3 <- plot.gem(c3, "C3", vol = T)

v.gem <- (pa1 + pb1 + pc1) / (pa2 + pb2 + pc2) / (pa3 + pb3 + pc3)
v.gem
```



#Volume- All Grains- OG- Scatterplot
```{r}
ggplot() + 
  xlim(0,750000) + ylim(0, 1000000) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=.7, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=1.42, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=.6, intercept=0, size=.1, linetype= 2) + #40%
  geom_abline(slope=1.66, intercept=0, size=.1, linetype= 2) + #40%
  labs(title = "Manual 2D vs. Nano-CT 3D Volume", subtitle="Calculated Using Ketcham et al. 2011 with W1 and W2", x= "2D Volume", y= "3D Volume") + 
   scale_color_d3(palette= "category10", 
                     name= "Geometric Index",
                    labels= c("A", "B", "C")) +
  #scale_shape_manual(values=c(15, 16, 17), name= "Roughness Index", labels=c("1", "2", "3")) +
  
  geom_point(df7, mapping=aes(x = s.v, y = db.v, color = gc), size = 2)
```

#Volume- All Grains- Max- Scatterplot + Regression
```{r}
error.lines(TRUE)
p + 
  labs(title = "Manual 2D vs. Nano-CT 3D Volume", x= "2D Volume", y= "3D Volume") + 
  scale_color_brewer(palette= "Set1", 
                    name= "Geometric Index",
                    labels= c("A", "B", "C")) +
  geom_point(apatite, mapping=aes(x = s.v, y = db.v, color=gc), size = 2) +               
  geom_smooth(mapping=aes(x = s.v, y = db.v, color=gc), data=apatite, method="lm", se=FALSE) +
  geom_abline(slope= 0.774, intercept = 33202)
```

#Volume- Common Grains Only- Max- Scatterplot + Regression
```{r}
ggplot() + 
  xlim(0,750000) + ylim(0,750000) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=.7, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=1.42, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=.6, intercept=0, size=.1, linetype= 2) + #40%
  geom_abline(slope=1.66, intercept=0, size=.1, linetype= 2) + #40%
  labs(title = "Manual 2D vs. Nano-CT 3D Volume", subtitle="Common Grains Only, With Regression Lines (lm), Zoomed", x= "2D Volume", y= "3D Volume") + 
 scale_color_d3(palette= "category10", 
                     name= "Geometric Index",
                    labels= c("A", "B", "C")) +
                   
  geom_point(df7, mapping=aes(x = s.v, y = db.v, color=gc), size = 2) +
  geom_smooth(mapping=aes(x = s.v, y = db.v, color=gc), data=df7, method="lm", se=FALSE) 
```

#Volume- Common + Small Grains- Max- Scatterplot + Regression
```{r}
ggplot() + 
  xlim(0,750000) + ylim(0,750000) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=.7, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=1.42, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=.6, intercept=0, size=.1, linetype= 2) + #40%
  geom_abline(slope=1.66, intercept=0, size=.1, linetype= 2) + #40%
  labs(title = "Manual 2D vs. Nano-CT 3D Volume", subtitle="Common + Small Grains, With Regression Lines (lm), Zoomed", x= "2D Volume", y= "3D Volume") + 
 scale_color_d3(palette= "category10", 
                    name= "Geometric Index",
                    labels= c("A", "B", "C")) +
                   
  geom_point(df7.small, mapping=aes(x = s.v, y = db.v, color=gc), size = 2) +
  geom_smooth(mapping=aes(x = s.v, y = db.v, color=gc),data= df7.small, method="lm", se=FALSE) 

```

#Volume- Common + Large Grains- Max- Scatterplot + Regression
```{r}
ggplot() + 
  xlim(0,750000) + ylim(0,750000) +
  geom_abline(slope=1, intercept = 0) + 
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=.7, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=1.42, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=.6, intercept=0, size=.1, linetype= 2) + #40%
  geom_abline(slope=1.66, intercept=0, size=.1, linetype= 2) + #40%
  labs(title = "Manual 2D vs. Nano-CT 3D Volume", subtitle="Common + Large Grains, With Regression Lines (lm), Zoomed", x= "2D Volume", y= "3D Volume") + 
  scale_color_d3(palette= "category10", 
                    name= "Geometric Index",
                    labels= c("A", "B", "C")) +
                  
  geom_point(df7.large, mapping=aes(x = s.v, y = db.v, color=gc), size = 2) +
  geom_smooth(mapping=aes(x = s.v, y = db.v, color=gc), data=df7.large, method="lm", se=FALSE)
```

########## Other Plots

#Heatmap of GEM
```{r}
gemnumber <- read_excel("/Users/spencerzeigler/Documents/Flowers Lab/Apatite Nano-CT Project_Feb 2019_June 2020/Step 8- Statistics/Data Comps_v7.xlsx", sheet="gemnumber")

ggplot(gemnumber, aes(gc, ri, fill=value)) +
  geom_tile() +
   scale_fill_distiller(palette = "RdPu", direction=1) + 
  labs(x= "Geometric Classification", y="Roundness Index") +
  scale_y_reverse() +
  scale_x_discrete(position="top")
```

######### Need to be fixed

#Error Bars- Ft
```{r}
quad.df.ft <- read_excel("/Users/spencerzeigler/Documents/Flowers Lab/Apatite Nano-CT Project_Feb 2019_June 2020/Step 8- Statistics/Linear Reg Results.xlsx", sheet= "ft.comp")

quad.df.ft <- quad.df.ft %>%
  select(gem, method.grains, slope, sigma.slope, intercept, sigma.intercept, gem.cat) 
quad.df.ft <- quad.df.ft[order(quad.df.ft$gem),]
quad.df.ft$gem <- factor(quad.df.ft$gem, levels = c("A1", "A2", "A3", "A", "B1", "B2", "B3", "B", "AB", "C1", "C2", "C3", "C"))
quad.df.ft$intercept <- as.numeric(as.character(quad.df.ft$intercept))

pal <- c("grey20", "darkorchid4")
#####################################################################

#Ft error bars, Slope
ggplot(quad.df.ft, aes(x=gem, y=slope, color=method.grains)) + 
   scale_color_nejm(palette="default", 
                    name = "Legend", 
                    labels= c("Intercept Not Fixed", "Intercept Fixed at 0")) +
geom_pointrange(aes(ymin=slope-sigma.slope, ymax=slope+sigma.slope, color= method.grains), alpha= .8) +
  labs(x="GEM", y="Slope")
```

#Error Bars- Volume
```{r}
quad.df.v <- read_excel("/Users/spencerzeigler/Documents/Flowers Lab/Apatite Nano-CT Project_Feb 2019_June 2020/Step 8- Statistics/Linear Reg Results.xlsx", sheet= "vol.reg.master")
quad.df.v <- quad.df.v[c(53:130),]

quad.df.v <- quad.df.v %>%
  select(gem, method.grains, slope, sigma.slope, intercept, sigma.intercept, gem.cat) 
quad.df.v <- quad.df.v[order(quad.df.v$gem),]

quad.df.v$gem <- factor(quad.df.v$gem, levels = c("A1", "A2", "A3", "A", "B1", "B2", "B3", "B", "AB", "C1", "C2", "C3", "C"))
quad.df.v <- quad.df.v %>%
  #filter(!method.grains == "common.only.lm") %>%
  #filter(!method.grains == "common.only.lm.fixed") %>%
  filter(!method.grains == "common.small.rlm") %>%
  filter(!method.grains == "common.large.rlm") %>%
  filter(!method.grains == "common.small.lm") %>%
  filter(!method.grains == "common.large.lm")

#####################################################################

#Volume error bars, Slope
ggplot(quad.df.v, mapping=aes(x=gem, y=slope, color= method.grains)) + 
geom_pointrange(aes(ymin=slope-sigma.slope, ymax=slope+sigma.slope)) +
scale_color_nejm(palette="default") +
labs(title= "1σ Error Bars on Volume Correction Lines for Each GEM", x="GEM", y="Slope")

#Volume error bars, Intercept
ggplot(quad.df.v, aes(x=gem, y=intercept, color= gem.cat)) + 
  scale_color_manual(values=pal, 
                     name="Legend", 
                     labels= c("A & B grains", "C Grains")) +
geom_pointrange(aes(ymin=intercept-sigma.intercept, ymax=intercept+sigma.intercept)) +
  labs(title= "1σ Error Bars on Volume Correction Line Intercepts for Each GEM", subtitle="Calculated with a WLS Linear Regression, Colored by Dataset Regressed", x="GEM", y="Intercept")
```

#Read in number_apatite data for plotting and set columns as factor
```{r}
number_apatite <- read_excel("./Analyzed vs Observed Binned Apatite Data_rmf_v2_jrm_final.xlsx", sheet = "R Cont")
number_apatite <- number_apatite[order(number_apatite$analyzed_width),]
number_apatite<- number_apatite[-c(1063:1102),] #only include grains <160
number_apatite<- number_apatite[-c(1:11),] #only include grains >40

number_apatite<- number_apatite[-c(1097:1102),] #only include grains <262+


as_tibble(number_apatite)

number_apatite$Bin <- factor(number_apatite$Bin, levels = c("40-50", "51-60", "61-70", "71-80", "81-90", "91-100", "101-110", "111-120", "121-130", "131-140", "141-150", "151-160", "161-170"))

number_apatite$size.name <- factor(number_apatite$size.name, levels=c("Small & Rare", "Small & Common","Typical & Common", "Large & Common", "Large & Rare"))
```


#Plot Analyzed vs. Observed Line Graph
```{r}
theme_set(theme_classic())

ggplot() +
  geom_area(number_apatite, stat="bin", fill="grey90", binwidth=5, mapping= aes(x= analyzed_width)) +
  geom_area(apatite, stat="bin", fill="black", binwidth=5, mapping=aes(x=j.w1)) +
  #scale_x_continuous(breaks= seq(40, 160, 10)) +
  #scale_y_continuous(breaks= seq(0, 120, 30), limits = c(0, 120)) +
  scale_x_continuous(breaks= seq(20, 220, 10)) +
  scale_y_continuous(breaks= seq(0, 120, 30), limits = c(0, 120)) +
  labs(x="Width (µm)", y="Number of Grains")
  #labs(title= "Number of Grains Selected for Nano-CT Analysis as a\nRepresentative Sample of 1100 Apatite Grains Run in the TraIL", x= "Width (µm)", y= "Number of Grains") 
  #theme(axis.text.x = element_text(angle = 60, vjust = 0.99, hjust=1))

```


############################################################################
Manuscript Draft Figures

1. Plot Results_Figure
```{r}
pvg <- plot.results(apatite, "s.v", "db.v", "geo", "volume") 
pvr <- plot.results(apatite, "s.v", "db.v", "rough", "volume")

psg <- plot.results(apatite, "s.sa", "db.sa", "geo", "surface")
psr <- plot.results(apatite, "s.sa", "db.sa", "rough", "surface")

pftg <- plot.results(apatite, "s.ft", "db.ft", "geo", "ft") 
pftr <- plot.results(apatite, "s.ft", "db.ft", "rough", "ft") 

peg <- plot.results(apatite, "s.esr.ft", "db.esr.ft", "geo", "esr")
per <- plot.results(apatite, "s.esr.ft", "db.esr.ft", "rough", "esr")

(pvg | pvr) / (psg | psr) / (pftg + pftr) / (peg + per) 
#save 1100 x 1300

```

2. GEM plot of common grains only with regression slope plotted! 
```{r}
pa1 <- plot.gem(a1, "A1")
pb1 <- plot.gem(b1, "B1")
pc1 <- plot.gem(c1, "C1")
pa2 <- plot.gem(a2, "A2")
pb2 <- plot.gem(b2, "B2")
pc2 <- plot.gem(c2, "C2")
pa3 <- plot.gem(a3, "A3")
pb3 <- plot.gem(b3, "B3")
pc3 <- plot.gem(c3, "C3")

ft.gem <- (pa1 + pb1 + pc1) / (pa2 + pb2 + pc2) / (pa3 + pb3 + pc3)
ft.gem
```

####################################################################################
Other/Unknown

Examining trends in QQ plots for my data
```{r}
par(mfrow=c(2,2))

mod<- lm(db.ft ~ s.ft, data=df7)
plot(mod)

mod1 <- lm(db.ft ~ s.ft, data= df7.rm)
plot(mod1)

#https://www.ucd.ie/ecomodel/Resources/QQplots_WebVersion.html
```

Notes and old color pals
```{r}
#brp.color <- c("lightseagreen", "firebrick3", "darkorchid3", "#E69F00", "lightseagreen", "firebrick3", "#56B4E9", "#009E73", "#0072B2", "#CC79A7", "#000000")
#bry.color <-c("#2C8C99", "#e5b400","#f44609","#EF476F","#faa612","#550527", "#688d27","#a10702", "#87B38D","#2C666E", "#4D8B31")
#accent.color <- c("#D95F02","cornflowerblue", "darkolivegreen", "darkorchid3")
#brewer.pal(n = 8, name = "Paired") #Pulls a palette from Rcolorbrewer and prints the hex codes

#To use ggsci https://cran.r-project.org/web/packages/ggsci/vignettes/ggsci.html
#scales::viridis_pal()(n=20)
```

Testing how to keep colors the same across plots for samples for morgan
```{r}
#Splits sample col by comma
#df7.sep <- separate(df7, sample, c("samplename", "round", "grain"))
#df7.sep$samplename <- factor(df7.sep$samplename, levels = c("MM", "DCA", "BF16", "16MFS05", "15MFS07", "Bail", "C50", "FCT"))
##Setting my color pallete. The order the colors are in matches the the samples. (ie. MM will be red; DCA will be blue; etc.)
#col.sample <- c("red", "blue", "yellow", "purple", "pink", "green", "orange", "black")

##Plotting my entire dataset
#ggplot(df7.sep, mapping = aes(s.ft, db.ft, color = samplename)) + 
  #scale_color_brewer(palette = "Set1", drop = TRUE,limits = levels(df7.sep$samplename)) +geom_point()

##Creating a new dataset by filtering. New dataset only contains mount 2. 
#df7.sep.mount2 <- df7.sep %>% filter(mount == 2) 

##Plotting mount 2
#p2 <- ggplot(df7.sep.mount2, mapping= aes(s.ft, db.ft, color=samplename)) + 
  #scale_color_brewer(palette = "Set1", drop=TRUE, limits = levels(df7.sep$samplename)) +geom_point()
```

Examining unsurprising trends in ESR I think
```{r}
ggplot() + 
  geom_point(df7, mapping=aes(s.esr.ft, db.esr.ft)) +
  geom_abline(slope=1, intercept=0)

ggplot() + 
  geom_point(df7, mapping=aes(s.rs.trad, db.rs.trad)) +
  geom_abline(slope=1, intercept=0)

ggplot() +
  geom_point(df7, mapping=aes(s.esr.ft, s.rs.trad))
ggplot() + 
  geom_point(df7, mapping=aes(db.esr.ft, db.rs.trad)) 

par(mfrow=c(1,2))

plot(df7$s.esr.ft, df7$s.rs.trad, xlab = "2D ESR Ft", ylab = "2D SA/V Rs")
plot(df7$db.esr.ft, df7$db.rs.trad, xlab = "3D ESR Ft", ylab = "3D SA/V Rs")

```

Ft 238 vs Ft 232
```{r}
ft.df <- read_excel("/Users/spencerzeigler/Documents/Flowers Lab/Apatite Nano-CT Project_Feb 2019_June 2020/Step 8- Statistics/SZ_Ft_Check_04202021.xlsx", sheet = "Ft Check_Final")
na.omit(ft.df)

#ft.df <- ft.df[-688,]
#ft.df <- ft.df[-360,]

p <- ggplot() + 
  geom_point(ft.df, mapping=aes(ft.238, mean.ft, key = sample)) + 
  geom_abline(slope=1, intercept=0) +
  geom_abline(slope=.95, intercept=0, size= .1, linetype= 2) + #5%
  geom_abline(slope=1.05263, intercept=0, size=.1, linetype= 2) + #5%
  geom_abline(slope=.9, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=1.1111111, intercept=0, size=.1, linetype= 2) + #10%
  geom_abline(slope=.8, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=1.25, intercept=0, size=.1, linetype= 2) + #20%
  geom_abline(slope=.7, intercept=0, size=.1, linetype= 2) + #30%
  geom_abline(slope=1.42, intercept=0, size=.1, linetype= 2)  #30%

shapiro.test(ft.df$ft.238)
qqline(ft.df$ft.238)

DescTools::SignTest(ft.df$ft.238, ft.df$mean.ft)

wilcox.test(ft.df$ft.238, ft.df$mean.ft) #the two populations are significantly different 
wilcox.test(ft.df$ft238.meanft, mu= 1)
```

#Checking if the regression line through the 238 vs total Ft data is within uncert. of a 1:1 line...it isn't. 
```{r}
x <- ft.df
robust.ft <- lm(mean.ft ~ ft.238, data=x)

sigma.slope.ft <- function(linreg, x) {
fit.ft <- summary(linreg)
fit.ft <- data.frame(fit.ft$coefficients)
df <- data.frame(twoD = x$ft.238,
                 threeD = x$mean.ft, 
                 intercept = rep(fit.ft[1,1], len=nrow(x)), 
                 slope = rep(fit.ft[2,1], len= nrow(x)))
df <- na.omit(df)

delta <- nrow(df) * sum(df$twoD^2) - (sum(df$twoD))^2
sigma.y <- sqrt(1/(nrow(df)-2)*sum((df$threeD - df$intercept - df$twoD*df$slope)^2))
uncert.slope <- sigma.y * sqrt(nrow(df)/delta)
}

sigma.incp.ft <- function(linreg, x) {
fit.ft <- summary(linreg)
fit.ft <- data.frame(fit.ft$coefficients)
df <- data.frame(twoD = x$ft.238,
                 threeD = x$mean.ft, 
                 intercept = rep(fit.ft[1,1], len=nrow(x)), 
                 slope = rep(fit.ft[2,1], len= nrow(x)))
df <- na.omit(df)

delta <- nrow(df) * sum(df$twoD^2) - (sum(df$twoD))^2
sigma.y <- sqrt(1/(nrow(df)-2)*sum((df$threeD - df$intercept - df$twoD*df$slope)^2))
uncert.incept <- sigma.y * sqrt((sum(df$twoD^2))/delta)
}


uncert.slope.ft <- sigma.slope.ft(robust.ft, x)
uncert.incep.ft <- sigma.incp.ft(robust.ft, x)

values <- summary(robust.ft)
stats.df.ft <- rbind(slope=values$coefficients[2,1], sigma.slope = uncert.slope.ft, intercept=values$coefficients[1,1], sigma.intercept = uncert.incep.ft)
stats.df.ft<- as.data.frame(t(as.matrix(stats.df.ft)))

#Slope

        x <- 1
        y <- 1.049366
  u <-  0
  w <-  0.004361325

diff <- x - y
uncert <- sqrt(u^2 + w^2)

if (abs(diff) < abs(uncert)) {
  print("Within 1sigma")
} else {
    print("Not within 1sigma")
}


#INtercept

x <- 0
        y <- 0.049793
  u <-  0
  w <-  0.003101313

diff <- x - y
uncert <- sqrt(u^2 + w^2)

if (abs(diff) < abs(uncert)) {
  print("Within 1sigma")
} else {
    print("Not within 1sigma")
}
```

SA:V Ratios 
```{r}
df7 <- df7 %>%
  dplyr::mutate(db.sav.ratio = 3*db.v/db.sa) %>%
  dplyr::mutate(s.sav.ratio = 3*s.v/s.sa)

ggplot() + 
  #xlim(0.03, .19) + ylim(0.03, .19) +
  geom_point(df7, mapping=aes(s.sav.ratio, db.sav.ratio, color= gc)) +
  geom_abline(slope=1, intercept=0) +
  #labs(title= "SAV.Ratio = SA/V", subtitle= "2D Overestimates SA and V, but 2D Underestimates SAV.Ratio") +
  scale_color_brewer(palette = "Dark2")

#cbpalette <- c("#88e99a", "#2d595a", "#41bbc5", "#5b588f", "#cddb9b")

```



